<!-- Copyright (c) 2025 Stu Eggerton. All rights reserved. -->
<!-- See LICENSE.md for license details. -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>TRMNL Private Plugin Tester</title>
    <link rel="icon" href="/icons8-plug-16.png" type="image/png">
    <link rel="stylesheet" href="/custom.css">
</head>
<body>
    <div class="controls">
        <select id="plugin">
            <option value="">Select a plugin</option>
        </select>
        <select id="layout">
            <option value="full">Full</option>
            <option value="half_horizontal">Half Horizontal</option>
            <option value="half_vertical">Half Vertical</option>
            <option value="quadrant">Quadrant</option>
        </select>
        <button onclick="loadPreview()" data-tooltip="Loads the sample.json from the plugin folder">Load Preview</button>
        <button onclick="loadLiveData()" class="live-button" style="background: #28a745;" data-tooltip="Loads the json data from the public_url specified in your plugin.json file">Load Live Data</button>
        <h1 class="controls-heading"><span>TRMNL</span> Plugin Dev</h1>
    </div>
    <div class="preview">
        <div class="empty-state">
            <p>Select a plugin or "All Plugins" and then press <code>Load Preview</code> or <code>Load Live Data</code></p>
        </div>
    </div>
    <div class="size-indicator">800 x 480</div>
    <div class="plugin-info" style="display: none; margin: 0 auto 20px; max-width: 800px; padding: 10px 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <span class="description"></span>
    </div>
    <div style="height: 100px;"></div>

    <div class="footer">
        Made with ❤️ by <a href="https://github.com/gitstua/">Stu</a> to enable the <a href="https://usetrmnl.com/">TRMNL</a> community. V0.3
        <span style="display: block; color: #666; font-size: 0.8em;" id="build-timestamp"></span>
    </div>

    <!-- Add popup HTML -->
    <div class="popup-overlay" id="welcomeOverlay">
        <div class="welcome-popup">
            <h2>
                <span style="color: #f8654b; font-weight: 600;">TRMNL</span>
                Plugin Dev Environment
            </h2>
            <p>
                Welcome to a tool that speeds up development and testing of plugins for 
                <a href="https://usetrmnl.com/" target="_blank">TRMNL</a> e-ink displays.
            </p>
            <p>
                For more information, check out the 
                <a href="https://github.com/gitstua/trmnl-plugin-dev#trmnl-plugin-tester" target="_blank">documentation</a>, 
                <a href="https://github.com/gitstua/trmnl-plugin-dev/" target="_blank">source code</a>, 
                and <a href="https://github.com/gitstua/trmnl-plugin-dev/blob/main/LICENSE.md" target="_blank">license</a>.
            </p>
            <p style="margin-top: 20px; font-style: italic;">
                Made with ❤️ by <a href="https://github.com/gitstua/">Stu</a> to enable the <a href="https://usetrmnl.com/">TRMNL</a> community. V0.3
            </p>
            <button onclick="closeWelcome()">Get Started</button>
        </div>
    </div>

    <!-- Add toast container -->
    <div id="toast" class="toast"></div>

    <script>
        async function loadPreview() {
            const pluginSelect = document.getElementById('plugin');
            const layout = document.getElementById('layout').value;
            const previewContainer = document.querySelector('.preview');
            
            // Show empty state if no plugin selected
            if (!pluginSelect.value) {
                previewContainer.innerHTML = `
                    <div class="empty-state">
                        <p>Select a plugin or "All Plugins" and then press <code>Load Preview</code></p>
                    </div>
                `;
                return;
            }

            // Clear existing content
            previewContainer.innerHTML = '';

            if (pluginSelect.value === 'all') {
                const response = await fetch('/api/plugins');
                const plugins = await response.json();
                const actualPlugins = plugins.filter(p => p.id !== 'all');
                
                actualPlugins.forEach(plugin => {
                    const wrapper = createPreviewElement(plugin, layout);
                    previewContainer.appendChild(wrapper);
                });
            } else {
                const plugin = {
                    id: pluginSelect.value,
                    name: pluginSelect.options[pluginSelect.selectedIndex].text
                };
                const wrapper = createPreviewElement(plugin, layout);
                previewContainer.appendChild(wrapper);
            }
        }

        async function loadLiveData() {
            const pluginSelect = document.getElementById('plugin');
            const layout = document.getElementById('layout').value;
            const previewContainer = document.querySelector('.preview');
            
            // Clear and rebuild the preview container
            previewContainer.innerHTML = '';

            if (pluginSelect.value === 'all') {
                const response = await fetch('/api/plugins');
                const plugins = await response.json();
                const actualPlugins = plugins.filter(p => p.id !== 'all');
                
                actualPlugins.forEach(plugin => {
                    const wrapper = createPreviewElement(plugin, layout, true);
                    previewContainer.appendChild(wrapper);
                });
            } else {
                const plugin = {
                    id: pluginSelect.value,
                    name: pluginSelect.options[pluginSelect.selectedIndex].text
                };
                const wrapper = createPreviewElement(plugin, layout, true);
                previewContainer.appendChild(wrapper);
            }
        }

        async function fetchRawToml(pluginId) {
            try {
                // Adjust endpoint based on single plugin mode
                const endpoint = pluginId === '.' 
                    ? '/api/plugin-toml/.'
                    : `/api/plugin-toml/${pluginId}`;
                    
                const response = await fetch(endpoint);
                if (!response.ok) throw new Error('Failed to fetch config.toml');
                return await response.text();
            } catch (error) {
                console.error('Error fetching config.toml:', error);
                return null;
            }
        }

        function createPreviewElement(plugin, layout, isLive = false) {
            const wrapper = document.createElement('div');
            wrapper.className = 'preview-wrapper';
            
            // Create left side with title and preview
            const leftSide = document.createElement('div');
            
            // Create title
            const title = document.createElement('h2');
            title.className = 'plugin-title';
            title.textContent = plugin.name;
            leftSide.appendChild(title);
            
            // Create preview container with screen
            const container = document.createElement('div');
            container.className = 'preview-container';
            
            const screen = document.createElement('div');
            screen.className = 'screen';
            
            // Create iframe for just the view
            const iframe = document.createElement('iframe');
            iframe.className = `view-frame ${layout}`;
            iframe.src = `/preview/${plugin.id}/${layout}${isLive ? '?live=true' : ''}`;
            screen.appendChild(iframe);
            
            container.appendChild(screen);
            leftSide.appendChild(container);
            wrapper.appendChild(leftSide);

            // Add the info panel (right side)
            const infoPanel = document.createElement('div');
            infoPanel.className = 'plugin-info-panel';
            
            // Fetch and display raw TOML content
            fetchRawToml(plugin.id).then(tomlContent => {
                if (tomlContent) {
                    const tomlPre = document.createElement('pre');
                    tomlPre.style.whiteSpace = 'pre-wrap';
                    tomlPre.textContent = tomlContent;
                    infoPanel.appendChild(tomlPre);
                }
            });

            // Add layout links section
            const layoutLinks = document.createElement('div');
            layoutLinks.className = 'layout-links';
            layoutLinks.innerHTML = `
                <h3>Layout Templates</h3>
                <div class="layout-buttons">
                    <button class="copy-button" onclick="copyLayout('${plugin.id}', 'full', event)" 
                        data-tooltip="Copy the full screen (800x480) layout template to clipboard">Copy Full Layout</button>
                    <button class="copy-button" onclick="copyLayout('${plugin.id}', 'half_horizontal', event)" 
                        data-tooltip="Copy the half height (800x240) layout template to clipboard">Copy Half Horizontal</button>
                    <button class="copy-button" onclick="copyLayout('${plugin.id}', 'half_vertical', event)" 
                        data-tooltip="Copy the half width (400x480) layout template to clipboard">Copy Half Vertical</button>
                    <button class="copy-button" onclick="copyLayout('${plugin.id}', 'quadrant', event)" 
                        data-tooltip="Copy the quarter size (400x240) layout template to clipboard">Copy Quadrant</button>
                </div>
            `;
            infoPanel.appendChild(layoutLinks);
            
            wrapper.appendChild(infoPanel);
            return wrapper;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Fetch available plugins
            const response = await fetch('/api/plugins');
            const plugins = await response.json();
            
            const select = document.getElementById('plugin');
            const preview = document.querySelector('.preview');
            
            plugins.forEach(plugin => {
                const option = document.createElement('option');
                option.value = plugin.id;
                option.textContent = plugin.name;
                select.appendChild(option);
            });

            // Auto-select if there's only one plugin
            if (plugins.length === 1) {
                select.value = plugins[0].id;
                // Optionally, trigger the preview load
                loadPreview();
            } else {
                // Set initial values from URL params
                const params = new URLSearchParams(window.location.search);
                const selectedPlugin = params.get('plugin');
                const selectedLayout = params.get('layout');
                
                if (selectedPlugin) {
                    select.value = selectedPlugin;
                }
                if (selectedLayout) {
                    document.getElementById('layout').value = selectedLayout;
                }
                
                // Auto-load preview if we have parameters
                if (selectedPlugin) {
                    loadPreview();
                }
            }

            // Handle welcome popup display - show only once per day
            const hasParams = Array.from(new URLSearchParams(window.location.search).keys()).length > 0;
            const lastShown = localStorage.getItem('welcomeLastShown');
            const today = new Date().toDateString();
            
            if (!hasParams && (!lastShown || lastShown !== today)) {
                document.getElementById('welcomeOverlay').style.display = 'block';
                localStorage.setItem('welcomeLastShown', today);
            } else {
                document.getElementById('welcomeOverlay').style.display = 'none';
            }

            // Add this to the existing DOMContentLoaded event listener
            try {
                const response = await fetch('/build.txt');
                if (response.ok) {
                    const timestamp = await response.text();
                    document.getElementById('build-timestamp').textContent = `Built at: ${timestamp}`;
                }
            } catch (error) {
                console.error('Failed to load build timestamp:', error);
            }
        });

        function showToast(message, type = 'error') {
            const toast = document.getElementById('toast');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                toast.style.display = 'none';
            }, 5000);
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showToast('Copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy:', err);
                showToast('Failed to copy to clipboard', 'error');
            }
        }

        async function copyLayout(pluginId, layoutName, event) {
            try {
                // Adjust the API endpoint based on whether we're in single plugin mode
                const endpoint = pluginId === '.' 
                    ? `/api/layout/${layoutName}`
                    : `/api/layout/${pluginId}/${layoutName}`;
                    
                const response = await fetch(endpoint);
                if (!response.ok) throw new Error('Failed to fetch layout');
                const layoutContent = await response.text();
                await copyToClipboard(layoutContent);
                
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            } catch (error) {
                console.error('Error copying layout:', error);
                showToast('Failed to copy layout', 'error');
                
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Error!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }
        }

        // Update the closeWelcome function
        function closeWelcome() {
            document.getElementById('welcomeOverlay').style.display = 'none';
            localStorage.setItem('welcomeLastShown', new Date().toDateString());
        }
    </script>
</body>
</html> 